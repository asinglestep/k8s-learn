# 零. 配置
```
Centos7
Kubernetes version: 1.9.0
Etcd version: 3.2.0
Docker version: 1.12.6
```

| ip | 说明 |
| -- | -- |
| 172.16.221.129 | master、node |
| 172.16.221.130 | node |
| 172.16.221.131 | node |

# 一. 安装
## 1. 安装etcd
```
go get github.com/coreos/etcd
cd $GOPATH/src/github.com/coreos/etcd
./build
```

## 2. 安装k8s
```
go get -d k8s.io/kubernetes
cd $GOPATH/src/k8s.io/kubernetes
make
```

## 3. 安装CFSSL
```
wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x cfssl_linux-amd64 cfssljson_linux-amd64
sudo mv cfssl_linux-amd64 /usr/local/bin/cfssl
sudo mv cfssljson_linux-amd64 /usr/local/bin/cfssljson
```

## 4. 安装docker-ce
```
(1). 移除旧的docker、docker-engine
sudo yum remove docker docker-common docker-selinux docker-engine

(2). 安装依赖
sudo yum install -y yum-utils device-mapper-persistent-data lvm2

(3). 添加源
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

(4). 安装docker-ce
sudo yum install docker-ce
```

# 二、生成证书和kubeconfig文件
## 1. 创建 CA
### (0). 说明
```
CN: kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法
O: kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)
```

### (1). 创建 CA 配置文件 ca-config.json
```
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}
```

### (2). 创建 CA 证书签名请求 ca-csr.json
```
{
  "CN": "kubernetes",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```

### (3). 生成 CA 证书和私钥
```
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
```

## 2. 创建 kubernetes 证书
### (1). 创建 kubernetes 证书签名请求文件 kubernetes-csr.json
```
{
    "CN": "kubernetes",
    "hosts": [
      "127.0.0.1",
      "172.16.221.129",
      "172.16.221.130",
      "172.16.221.131",
      "10.254.0.1",
      "kubernetes",
      "kubernetes.default",
      "kubernetes.default.svc",
      "kubernetes.default.svc.cluster",
      "kubernetes.default.svc.cluster.local"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "BeiJing",
            "L": "BeiJing",
            "O": "k8s",
            "OU": "System"
        }
    ]
}
```
注： 如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表

### (2). 生成 kubernetes 证书和私钥 
```
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes
```

## 3. 创建 admin 证书
### (1). 创建 admin 证书签名请求文件 admin-csr.json
```
{
  "CN": "admin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "system:masters",
      "OU": "System"
    }
  ]
}
```

### (2). 生成 admin 证书和私钥
```
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
```

## 4. 创建 kube-proxy 证书
### (1). 创建 kube-proxy 证书签名请求文件 kube-proxy-csr.json
```
{
  "CN": "system:kube-proxy",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
```

### (2). 生成 kube-proxy 客户端证书和私钥
```
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy
```

## 5. 生成token
```
export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')
echo ${BOOTSTRAP_TOKEN},kubelet-bootstrap,10001,"system:kubelet-bootstrap" > token.csv
```

## 6. 生成kubelet kubeconfig文件
```
kubectl config set-cluster kubernetes --certificate-authority=ca.pem  --embed-certs=true --server=https://172.16.221.129:6443 --kubeconfig=kubelet-bootstrap.kubeconfig

kubectl config set-credentials kubelet-bootstrap --token=${BOOTSTRAP_TOKEN} --kubeconfig=kubelet-bootstrap.kubeconfig

kubectl config set-context default  --cluster=kubernetes --user=kubelet-bootstrap  --kubeconfig=kubelet-bootstrap.kubeconfig

kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig
```

## 7. 生成kube-proxy kubeconfig文件
```
kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://172.16.221.129:6443 --kubeconfig=kube-proxy.kubeconfig

kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem  --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig

kubectl config set-context default --cluster=kubernetes  --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig

kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig
```

## 8. 将token.csv文件中的kubelet-bootstrap 用户赋予 system:node-bootstrapper cluster 角色(role)，kubelet 才能有权限创建认证请求
```
cd /etc/k8s
kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap
```

# 三、启动
## 1. 关闭所有节点防火墙
```
sudo systemctl stop firewalld.service
sudo systemctl disable firewalld.service // 禁止开机启动
```

## 2. 启动etcd
```
$GOPATH/src/github.com/coreos/etcd/bin/etcd --advertise-client-urls=http://0.0.0.0:2379 --listen-client-urls=http://0.0.0.0:2379
```

## 3. 启动docker
```
systemctl start docker
```

## 3. 启动master
### (1). 将master的ip写到/etc/hosts
```
echo xxxx k8s-master >> /etc/hosts
```

### (2). 拷贝证书、kubeconfig和token文件
```
sudo mkdir /etc/k8s
sudo mkdir /etc/k8s/ssl
sudo cp *.pem /etc/k8s/ssl
sudo cp *.kubeconfig /etc/k8s
sudo cp token.csv  /etc/k8s 
```

### (3). 启动kube-apiserver
```
sudo $GOPATH/src/k8s.io/kubernetes/_output/bin/kube-apiserver --advertise-address=0.0.0.0 --bind-address=0.0.0.0 --insecure-bind-address=0.0.0.0 --etcd-servers=http://127.0.0.1:2379 --service-cluster-ip-range=10.254.0.0/16 --admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota --authorization-mode=RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --token-auth-file=/etc/k8s/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/k8s/ssl/kubernetes.pem --tls-private-key-file=/etc/k8s/ssl/kubernetes-key.pem --client-ca-file=/etc/k8s/ssl/ca.pem --service-account-key-file=/etc/k8s/ssl/ca-key.pem 
```

注：
--authorization-mode=RBAC 指定在安全端口使用 RBAC 授权模式，拒绝未通过授权的请求

### (4). 启动kube-controller-manager
```
sudo $GOPATH/src/k8s.io/kubernetes/_output/bin/kube-controller-manager --address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/k8s/ssl/ca.pem --cluster-signing-key-file=/etc/k8s/ssl/ca-key.pem --service-account-private-key-file=/etc/k8s/ssl/ca-key.pem --root-ca-file=/etc/k8s/ssl/ca.pem --leader-elect=true --master=http://127.0.0.1:8080
```

### (5). 启动kube-scheduler
```
sudo $GOPATH/src/k8s.io/kubernetes/_output/bin/kube-scheduler --leader-elect=true --address=127.0.0.1 --master=http://127.0.0.1:8080
```

### (6). 启动kubelet
```
sudo $GOPATH/src/k8s.io/kubernetes/_output/bin/kubelet --address=172.16.221.131 --hostname-override=172.16.221.131 --pod-infra-container-image=sz-pg-oam-docker-hub-001.tendcloud.com/library/pod-infrastructure:rhel7 --cgroup-driver=cgroupfs --cluster-dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/k8s/kubelet-bootstrap.kubeconfig --kubeconfig=/etc/k8s/kubelet.kubeconfig --require-kubeconfig --cert-dir=/etc/k8s/ssl --cluster-domain=cluster.local. --hairpin-mode promiscuous-bridge --serialize-image-pulls=false --fail-swap-on=false
```

#### 注:
```
(1). 查看未授权的 CSR 请求
kubectl get csr
(2). 通过 CSR 请求
kubectl certificate approve XXX(未授权的csr名字)
(3). 报 Unable to register node "172.16.221.131" with API server: nodes is forbidden: User "system:node:172.16.221.131" cannot create nodes at the cluster scope错时，给node的用户或组添加system:node权限
kubectl create clusterrolebinding node-172.16.221.131 --clusterrole=system:node  --user=system:node:172.16.221.131
(4). 报Failed to get system container stats for "/user.slice/user-1000.slice/session-40.scope": failed to get cgroup stats for "/user.slice/user-1000.slice/session-40.scope": failed to get container info for "/user.slice/user-1000.slice/session-40.scope": unknown container "/user.slice/user-1000.slice/session-40.scope"错时，启动kubelet加 --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice 参数
```

### (7). 启动kube-proxy
```
sudo $GOPATH/src/k8s.io/kubernetes/_output/bin/kube-proxy --bind-address=172.16.221.131 --hostname-override=172.16.221.131 --kubeconfig=/etc/k8s/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16
```

